<?php

function hubspot_menu()
{
    $items = array();
    
    $items['admin/config/hubspot'] = array(
        'title' => 'HubSpot integration settings',
        'description' => 'Set up HubSpot integration and leads insertion.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('hubspot_admin_settings'),
        'access arguments' => array('administer site configuration'),
        'type' => MENU_NORMAL_ITEM,
        'file' => 'hubspot.admin.inc'
    );
    
    return $items;
}

/**
 * Intercept the WebForm submission and send it off to HubSpot.
 */
function hubspot_webform_submission_insert($node, $submission)
{
    if ($submission->is_draft == 1)
        return;
    
    // Now, $submission->data is an array indexed by component ID.
    // We must find the matching field names.
    $values = array();
    
    $hubSpotURL = '';
    foreach ($submission->data as $cid => $data)
    {
        if ($node->webform['components'][$cid]['type'] == 'hubspot_url')
        {
            $hubSpotURL = $data['value'][0];
            continue; // omit HubSpot URL from POST
        }
        
        $component = $node->webform['components'][$cid]['form_key'];
        $values[$component] = implode(',', $data['value']);
    }
    
    if (empty($hubSpotURL))
    {
        // We're only interested in forms with HubSpot URLs to POST to
        return;
    }
        
    $hapi = new HAPILeads();
    
    $hapi->setHAPIKey(variable_get('hubspot_apikey', ''));
    $hapi->executeInsertLead($formName, $hubSpotURL, $values);
}

/**
 * Create a WebForm component to contain the form's HubSpot POST URL.
 */
function hubspot_webform_component_info()
{
    return array(
        'hubspot_url' => array(
            'label' => t('HubSpot POST URL'),
            'description' => t('The API POST URL supplied by HubSpot for this form'),
            'features' => array(
                'csv' => false,
                'email' => false
            )
        )
    );
}

function _webform_defaults_hubspot_url()
{
    return array(
        'name' => 'HubSpot POST URL',
        'form_key' => 'hubspot',
        'pid' => 0,
        'weight' => 0,
        'value' => '',
        'extra' => array(
        ),
    );
}

function _webform_edit_hubspot_url($component)
{
    $form = array();
    
    // Disable Description box
    $form['extra']['description'] = array();
    
    $form['value'] = array(
        '#type' => 'textfield',
        '#title' => t('HubSpot POST URL'),
        '#description' => 'That URL thingy',
        '#default_value' => $component['value']
    );
    
    // Hide display options
    $form['display'] = array('#type' => 'markup');
    
    return $form;
}

/**
 * Implements _webform_render_component().
 */
function _webform_render_hubspot_url($component, $value = NULL)
{
    $element = array(
        '#type' => 'hidden',
        '#title' => check_plain($component['name']),
        '#default_value' => check_url($component['value']),
        '#weight' => $component['weight'],
    );
    
    if (isset($value[0]))
    {
        $element['#default_value'] = $value[0];
    }

    return $element;
}

function _webform_display_hubspot_url($component, $value, $format = 'html')
{
    return array();
}
?>
