<?php
/**
 * @file
 * Sends Webform results to HubSpot's Leads API by using Webform's provided hooks.
 */


function hubspot_menu()
{
    $items = array();
    
    $items['admin/config/hubspot'] = array(
        'title' => 'HubSpot integration settings',
        'description' => 'Set up HubSpot integration and leads insertion.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('hubspot_admin_settings'),
        'access arguments' => array('administer site configuration'),
        'type' => MENU_NORMAL_ITEM,
        'file' => 'hubspot.admin.inc'
    );
    
    return $items;
}

/**
 * Intercept the WebForm submission and send it off to HubSpot.
 */
function hubspot_webform_submission_insert($node, $submission)
{
    if ($submission->is_draft == 1)
        return;
    
    // Now, $submission->data is an array indexed by component ID.
    // We must find the matching field names.
    $values = array();
    
    $hubSpotURL = '';
    foreach ($submission->data as $cid => $data)
    {
        if ($node->webform['components'][$cid]['type'] == 'hubspot_url')
        {
            $hubSpotURL = $data['value'][0];
            continue; // omit HubSpot URL from POST
        }
        
        $component = $node->webform['components'][$cid]['form_key'];
        $values[$component] = implode(',', $data['value']);
    }
    
    if (empty($hubSpotURL))
    {
        // We're only interested in forms with HubSpot URLs to POST to
        return;
    }
    
    // These fields must be submitted with each request
    $values['UserToken'] = isset($_COOKIE['hubspotutk']) ? $_COOKIE['hubspotutk'] : '';
    $values['IPAddress'] = $_SERVER['REMOTE_ADDR'];
    
    $hapi = new HAPILeads();
    
    $hapi->setHAPIKey(variable_get('hubspot_apikey', ''));
    $r = $hapi->executeInsertLead($hubSpotURL, $values);
    
    if (empty($r['Error']))
    {
        watchdog('hubspot', strip_tags($r['Data']), NULL, WATCHDOG_INFO);
    }
    else
    {
        watchdog('hubspot', 'cURL error when submitting HubSpot data: @error',
                 array('@error' => $r['ErrorMessage']), WATCHDOG_ERROR);
    }
}

/**
 * Create a WebForm component to contain the form's HubSpot POST URL.
 */
function hubspot_webform_component_info()
{
    return array(
        'hubspot_url' => array(
            'label' => t('HubSpot POST URL'),
            'description' => t('A HubSpot API POST URL, to submit a form\'s contents to HubSpot Leads.'),
            'features' => array(
                'csv' => FALSE,
                'email' => FALSE,
                'title_display' => FALSE, // this prevents the "Display" field from being displayed while editing the component
                'required' => FALSE
            )
        )
    );
}

/**
 * Provide default values for this component.
 */
function _webform_defaults_hubspot_url()
{
    return array(
        'name' => 'HubSpot POST URL',
        'form_key' => 'hubspot',
        'pid' => 0,
        'weight' => 0,
        'value' => '',
        'extra' => array(
        ),
    );
}

function _webform_edit_hubspot_url($component)
{
    $form = array();
    
    // Disable Description box
    $form['extra']['description'] = array();
    
    $form['value'] = array(
        '#type' => 'textfield',
        '#title' => t('HubSpot POST URL'),
        '#description' => t('The API POST URL provided under HubSpot\'s Lead API settings for this form.'),
        '#default_value' => $component['value']
    );
    
    // Hide display options
    $form['display'] = array('#type' => 'markup');
    
    // Overwrite the "Label" field to provide a better description
    $form['name'] = array(
        '#type' => 'textfield',
        '#default_value' => $component['name'],
        '#title' => t('Label'),
        '#description' => t('The name of this field. This field will not be displayed to users submitting the form.'),
        '#required' => TRUE,
        '#weight' => -10,
        '#maxlength' => 255,
    );
    
    return $form;
}

/**
 * Implements _webform_render_component(). Render this as a hidden field.
 */
function _webform_render_hubspot_url($component, $value = NULL)
{
    $element = array(
        '#type' => 'hidden',
        '#title' => check_plain($component['name']),
        '#default_value' => check_url($component['value']),
        '#weight' => $component['weight'],
    );
    
    if (isset($value[0]))
    {
        $element['#default_value'] = $value[0];
    }

    return $element;
}

/**
 * When displaying the form results to an admin, don't bother showing the HubSpot URL.
 */
function _webform_display_hubspot_url($component, $value, $format = 'html')
{
    return array();
}

function hubspot_help($path, $arg)
{
    $output = '';
    switch ($path)
    {
        case 'admin/help#hubspot':
            $output .= '<h3>' . t('About') . '</h3>';
            $output .= '<p>' . t('The HubSpot module provides leads integration with the HubSpot API, allowing forms created with the Webform module to submit their data to HubSpot for leads tracking.') . '</p>';
            
            $output .= '<h3>' . t('Sending a form to HubSpot') . '</h3>';
            $output .= '<p>' . t('To have a form\'s data sent to HubSpot for leads tracking, complete the following steps:') . '</p>';
            $output .= '<ul>';
            $output .= '<li>' . t('Log in to your HubSpot account and visit the Settings page. Click the HubSpot Lead API link under Lead Management.') . '</li>';
            $output .= '<li>' . t('Press Add New Form and specify the form name, email list, and lead nurturing campaign as desired.') . '</li>';
            $output .= '<li>' . t('Submit the form. HubSpot will now provide an API POST URL; save this somewhere.') . '</li>';
            $output .= '<li>' . t('In your Drupal admin, use the Add content page to create a new Webform. Enter as many questions ("components") as you\'d like.') . '</li>';
            $output .= '<li>' . t('Finally, create a component named "hubspot" with the type "HubSpot POST URL". Supply the API POST URL in the box provided and save the form.') . '</li>';
            $output .= '</ul>';
            $output .= '<p>' . t('The Webform will now automatically send any submissions directly to HubSpot via the POST URL you provided. You may customize, theme, or alter the form as much as you like, so long as the HubSpot POST URL field remains.') . '</p>';
            
            $output .= '<h3>' . t('Form field names') . '</h3>';
            $output .= '<p>' . t('Certain form field keys have significance with HubSpot. For example, submitting a field with the key "FirstName" allows HubSpot to automatically recognize it as the person\'s first name when displaying the lead information. Here is a list of HubSpot-recognized field keys:') . '</p>';
            $output .= '<dl>';
            $output .= '<dt>' . t('FirstName, LastName, and FullName') . '</dt>';
            $output .= '<dd>' . t('Use FirstName or LastName to send those fields separately; send FullName for HubSpot to automatically split the name into first and last names.') . '</dd>';
            $output .= '<dt>' . t('Email, Phone, Fax, Website, and TwitterHandle') . '</dt>';
            $output .= '<dd>' . t('Specify these field keys to get the user\'s contact information recognized by HubSpot.') . '</dd>';
            $output .= '<dt>' . t('Company, NumberEmployees, AnnualRevenue, and JobTitle') . '</dt>';
            $output .= '<dd>' . t('Capture the user\'s employment information.') . '</dd>';
            $output .= '<dt>' . t('Address, City, State, ZipCode, Country') . '</dt>';
            $output .= '<dd>' . t('Capture the user\'s location.') . '</dd>';
            $output .= '<dt>' . t('Message') . '</dd>';
            $output .= '<dd>' . t('Allow the user to send a custom message.') . '</dd>';
            $output .= '</dl>';
            $output .= '<p>' . t('Specify these as the <strong>Field Key</strong> when adding components in your form. The field key is not shown to users filling out the form, but only sent to HubSpot; the "Label" field specifies what your users will see.') . '</p>';
            $output .= '<p>' . t('Note that you may provide other custom fields with any field key you like, if you have other data you wish to collect. HubSpot will store all data sent to it and display it in the "Form Data" tab when viewing each lead.') . '</p>';
    }
    return $output;
}
